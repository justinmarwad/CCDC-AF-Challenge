/*
 * DVIDSVideoAnalytics.js
 * Video analytics for the DVIDS Platform
 * v0.1.2
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.DVIDSVideoAnalytics=e()}(this,function(){"use strict";function t(t){return void 0===t}function e(t){return Array.isArray(t)}function n(t){return t&&"number"==typeof t.size&&"string"==typeof t.type&&"function"==typeof t.slice}var i=function i(o,r,a,c){if(r instanceof FormData&&(c=a,a=r,r=null),(r=r||{}).indices=!t(r.indices)&&r.indices,r.nulls=!!t(r.nulls)||r.nulls,a=a||new FormData,t(o))return a;if(function(t){return null===t}(o))r.nulls&&a.append(c,"");else if(e(o))if(o.length)o.forEach(function(t,e){var n=c+"["+(r.indices?e:"")+"]";i(t,r,a,n)});else{var s=c+"[]";a.append(s,"")}else!function(t){return t instanceof Date}(o)?!function(t){return t===Object(t)}(o)||function(t){return n(t)&&("object"==typeof t.lastModifiedDate||"number"==typeof t.lastModified)&&"string"==typeof t.name}(o)||n(o)?a.append(c,o):Object.keys(o).forEach(function(t){var n=o[t];if(e(n))for(;t.length>2&&t.lastIndexOf("[]")===t.length-2;)t=t.substring(0,t.length-2);i(n,r,a,c?c+"["+t+"]":t)}):a.append(c,o.toISOString());return a},o={set:function(t,e,n,i){var o="",r="";if(n){var a=new Date;a.setTime(a.getTime()+60*n*1e3),o="; expires="+a.toGMTString()}i&&(r="; domain="+i),document.cookie=t+"="+escape(e)+o+r+"; path=/"},get:function(t){var e,n,i=t+"=",o=document.cookie.split(";");for(e=0;e<o.length;e++){for(n=o[e];" "===n.charAt(0);)n=n.substring(1,n.length);if(0===n.indexOf(i))return unescape(n.substring(i.length,n.length))}return null}},r={urlPrefix:"https://analytics.dvidshub.net",visitsUrl:"/ahoy/visits",eventsUrl:"/loaded",endedUrl:"/ended",playUrl:"/play",loadedUrl:"/loaded",domain:"",cookieDomain:null,page:null,platform:"Web",useBeacon:!1,startOnReady:!0,trackVisits:!1,cookies:!0},a=window.ahoy||window.Ahoy||{};a.configure=function(t){for(var e in t)t.hasOwnProperty(e)&&(r[e]=t[e])},a.configure(a);var c,s,u,f,d=window.jQuery||window.Zepto||window.$,l=240,p=1051200,h=!1,g=[],v="undefined"!=typeof JSON&&void 0!==JSON.stringify,y=[];function m(t){return r.urlPrefix+"/"+t.name}function k(t,e,n){o.set(t,e,n,r.cookieDomain||r.domain)}function x(t){return o.get(t)}function w(t){o.set(t,"",-1)}function b(t){x("ahoy_debug")&&window.console.log(t)}function _(){for(var t;t=g.shift();)t();h=!0}function S(t){h?t():g.push(t)}function O(t,e,n){document.addEventListener(t,function(t){(function(t,e){var n=t.matches||t.matchesSelector||t.mozMatchesSelector||t.msMatchesSelector||t.oMatchesSelector||t.webkitMatchesSelector;return n?n.apply(t,[e]):(b("Unable to match"),!1)})(t.target,e)&&n(t)})}function V(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})}function j(){r.cookies&&v&&k("ahoy_events",JSON.stringify(y),1)}function T(){var t=document.querySelector("meta[name=csrf-token]");return t&&t.content}function M(t){var e=T();e&&t.setRequestHeader("X-CSRF-Token",e)}function N(t,e,n){if(v)if(d)d.ajax({type:"POST",url:t,data:JSON.stringify(e),contentType:"application/json; charset=utf-8",dataType:"json",beforeSend:M,success:n});else{var i=new XMLHttpRequest;i.open("POST",t,!0),i.setRequestHeader("Content-Type","application/json"),i.onload=function(){200===i.status&&n()},M(i),i.send(JSON.stringify(e))}}function C(t){var e=Object.assign({},t,t.properties);return r.cookies&&(e.visit_token=t.visit_token,e.visitor_token=t.visitor_token),delete e.properties,delete e.js,delete t.visit_token,delete t.visitor_token,e}function D(t){S(function(){N(m(t),C(t),function(){for(var e=0;e<y.length;e++)if(y[e].id==t.id){y.splice(e,1);break}j()})})}function A(t){S(function(){var e,n=C(t),o=(e=document.querySelector("meta[name=csrf-param]"))&&e.content,r=T();o&&r&&(n[o]=r),n.events_json=JSON.stringify(n.events),delete n.events,window.navigator.sendBeacon(m(),i(n))})}function I(){return r.page||window.location.pathname}function P(t){return t&&t.length>0?t:null}function J(t){var e=t.target;return function(t){for(var e in t)t.hasOwnProperty(e)&&null===t[e]&&delete t[e];return t}({tag:e.tagName.toLowerCase(),id:P(e.id),class:P(e.className),page:I(),section:function(t){for(;t&&t!==document;t=t.parentNode)if(t.hasAttribute("data-section"))return t.getAttribute("data-section");return null}(e)})}function U(){if(h=!1,c=a.getVisitId(),s=a.getVisitorId(),u=x("ahoy_track"),!1===r.cookies||!1===r.trackVisits)b("Visit tracking disabled"),_();else if(c&&s&&!u)b("Active visit"),_();else if(c||k("ahoy_visit",c=V(),l),x("ahoy_visit")){b("Visit started"),s||k("ahoy_visitor",s=V(),p);var t={visit_token:c,visitor_token:s,platform:r.platform,landing_page:window.location.href,screen_width:window.screen.width,screen_height:window.screen.height,js:!0};document.referrer.length>0&&(t.referrer=document.referrer),b(t),N(r.urlPrefix+r.visitsUrl,t,function(){w("ahoy_track"),_()})}else b("Cookies disabled"),_()}a.getVisitId=a.getVisitToken=function(){return x("ahoy_visit")},a.getVisitorId=a.getVisitorToken=function(){return x("ahoy_visitor")},a.reset=function(){return w("ahoy_visit"),w("ahoy_visitor"),w("ahoy_events"),w("ahoy_track"),!0},a.debug=function(t){return!1===t?w("ahoy_debug"):k("ahoy_debug","t",525600),!0},a.track=function(t,e){var n={name:t,properties:e||{},type:"video",js:!0};return S(function(){r.cookies&&!a.getVisitId()&&U(),S(function(){b(n),(r.useBeacon||r.trackNow)&&v&&void 0!==window.navigator.sendBeacon?A(n):(y.push(n),j(),setTimeout(function(){D(n)},1e3))})}),!0},a.trackView=function(t){var e={url:window.location.href,title:document.title,page:I()};if(t)for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);a.track("$view",e)},a.trackClicks=function(){O("click","a, button, input[type=submit]",function(t){var e=t.target,n=J(t);n.text="input"==n.tag?e.value:(e.textContent||e.innerText||e.innerHTML).replace(/[\s\r\n]+/g," ").trim(),n.href=e.href,a.track("$click",n)})},a.trackSubmits=function(){O("submit","form",function(t){var e=J(t);a.track("$submit",e)})},a.trackChanges=function(){O("change","input, textarea, select",function(t){var e=J(t);a.track("$change",e)})},a.trackAll=function(){a.trackView(),a.trackClicks(),a.trackSubmits(),a.trackChanges()};try{y=JSON.parse(x("ahoy_events")||"[]")}catch(t){}for(var L=0;L<y.length;L++)D(y[L]);return a.start=function(){U(),a.start=function(){}},f=function(){r.startOnReady&&a.start()},"interactive"===document.readyState||"complete"===document.readyState?f():document.addEventListener("DOMContentLoaded",f),a});
